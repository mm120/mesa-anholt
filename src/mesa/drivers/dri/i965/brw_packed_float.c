/*
 * Copyright Â© 2011 Intel Corporation
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice (including the next
 * paragraph) shall be included in all copies or substantial portions of the
 * Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

#include "brw_context.h"
#include "brw_eu.h"

/* Table contents generated by brw_packed_float_gen.c */
static const float packed_to_float[256] = {
   [0x00] = 0.0000000000,
   [0x01] = 0.1328125000,
   [0x02] = 0.1406250000,
   [0x03] = 0.1484375000,
   [0x04] = 0.1562500000,
   [0x05] = 0.1640625000,
   [0x06] = 0.1718750000,
   [0x07] = 0.1796875000,
   [0x08] = 0.1875000000,
   [0x09] = 0.1953125000,
   [0x0a] = 0.2031250000,
   [0x0b] = 0.2109375000,
   [0x0c] = 0.2187500000,
   [0x0d] = 0.2265625000,
   [0x0e] = 0.2343750000,
   [0x0f] = 0.2421875000,
   [0x10] = 0.2500000000,
   [0x11] = 0.2656250000,
   [0x12] = 0.2812500000,
   [0x13] = 0.2968750000,
   [0x14] = 0.3125000000,
   [0x15] = 0.3281250000,
   [0x16] = 0.3437500000,
   [0x17] = 0.3593750000,
   [0x18] = 0.3750000000,
   [0x19] = 0.3906250000,
   [0x1a] = 0.4062500000,
   [0x1b] = 0.4218750000,
   [0x1c] = 0.4375000000,
   [0x1d] = 0.4531250000,
   [0x1e] = 0.4687500000,
   [0x1f] = 0.4843750000,
   [0x20] = 0.5000000000,
   [0x21] = 0.5312500000,
   [0x22] = 0.5625000000,
   [0x23] = 0.5937500000,
   [0x24] = 0.6250000000,
   [0x25] = 0.6562500000,
   [0x26] = 0.6875000000,
   [0x27] = 0.7187500000,
   [0x28] = 0.7500000000,
   [0x29] = 0.7812500000,
   [0x2a] = 0.8125000000,
   [0x2b] = 0.8437500000,
   [0x2c] = 0.8750000000,
   [0x2d] = 0.9062500000,
   [0x2e] = 0.9375000000,
   [0x2f] = 0.9687500000,
   [0x30] = 1.0000000000,
   [0x31] = 1.0625000000,
   [0x32] = 1.1250000000,
   [0x33] = 1.1875000000,
   [0x34] = 1.2500000000,
   [0x35] = 1.3125000000,
   [0x36] = 1.3750000000,
   [0x37] = 1.4375000000,
   [0x38] = 1.5000000000,
   [0x39] = 1.5625000000,
   [0x3a] = 1.6250000000,
   [0x3b] = 1.6875000000,
   [0x3c] = 1.7500000000,
   [0x3d] = 1.8125000000,
   [0x3e] = 1.8750000000,
   [0x3f] = 1.9375000000,
   [0x40] = 2.0000000000,
   [0x41] = 2.1250000000,
   [0x42] = 2.2500000000,
   [0x43] = 2.3750000000,
   [0x44] = 2.5000000000,
   [0x45] = 2.6250000000,
   [0x46] = 2.7500000000,
   [0x47] = 2.8750000000,
   [0x48] = 3.0000000000,
   [0x49] = 3.1250000000,
   [0x4a] = 3.2500000000,
   [0x4b] = 3.3750000000,
   [0x4c] = 3.5000000000,
   [0x4d] = 3.6250000000,
   [0x4e] = 3.7500000000,
   [0x4f] = 3.8750000000,
   [0x50] = 4.0000000000,
   [0x51] = 4.2500000000,
   [0x52] = 4.5000000000,
   [0x53] = 4.7500000000,
   [0x54] = 5.0000000000,
   [0x55] = 5.2500000000,
   [0x56] = 5.5000000000,
   [0x57] = 5.7500000000,
   [0x58] = 6.0000000000,
   [0x59] = 6.2500000000,
   [0x5a] = 6.5000000000,
   [0x5b] = 6.7500000000,
   [0x5c] = 7.0000000000,
   [0x5d] = 7.2500000000,
   [0x5e] = 7.5000000000,
   [0x5f] = 7.7500000000,
   [0x60] = 8.0000000000,
   [0x61] = 8.5000000000,
   [0x62] = 9.0000000000,
   [0x63] = 9.5000000000,
   [0x64] = 10.0000000000,
   [0x65] = 10.5000000000,
   [0x66] = 11.0000000000,
   [0x67] = 11.5000000000,
   [0x68] = 12.0000000000,
   [0x69] = 12.5000000000,
   [0x6a] = 13.0000000000,
   [0x6b] = 13.5000000000,
   [0x6c] = 14.0000000000,
   [0x6d] = 14.5000000000,
   [0x6e] = 15.0000000000,
   [0x6f] = 15.5000000000,
   [0x70] = 16.0000000000,
   [0x71] = 17.0000000000,
   [0x72] = 18.0000000000,
   [0x73] = 19.0000000000,
   [0x74] = 20.0000000000,
   [0x75] = 21.0000000000,
   [0x76] = 22.0000000000,
   [0x77] = 23.0000000000,
   [0x78] = 24.0000000000,
   [0x79] = 25.0000000000,
   [0x7a] = 26.0000000000,
   [0x7b] = 27.0000000000,
   [0x7c] = 28.0000000000,
   [0x7d] = 29.0000000000,
   [0x7e] = 30.0000000000,
   [0x7f] = 31.0000000000,
   [0x80] = -0.0000000000,
   [0x81] = -0.1328125000,
   [0x82] = -0.1406250000,
   [0x83] = -0.1484375000,
   [0x84] = -0.1562500000,
   [0x85] = -0.1640625000,
   [0x86] = -0.1718750000,
   [0x87] = -0.1796875000,
   [0x88] = -0.1875000000,
   [0x89] = -0.1953125000,
   [0x8a] = -0.2031250000,
   [0x8b] = -0.2109375000,
   [0x8c] = -0.2187500000,
   [0x8d] = -0.2265625000,
   [0x8e] = -0.2343750000,
   [0x8f] = -0.2421875000,
   [0x90] = -0.2500000000,
   [0x91] = -0.2656250000,
   [0x92] = -0.2812500000,
   [0x93] = -0.2968750000,
   [0x94] = -0.3125000000,
   [0x95] = -0.3281250000,
   [0x96] = -0.3437500000,
   [0x97] = -0.3593750000,
   [0x98] = -0.3750000000,
   [0x99] = -0.3906250000,
   [0x9a] = -0.4062500000,
   [0x9b] = -0.4218750000,
   [0x9c] = -0.4375000000,
   [0x9d] = -0.4531250000,
   [0x9e] = -0.4687500000,
   [0x9f] = -0.4843750000,
   [0xa0] = -0.5000000000,
   [0xa1] = -0.5312500000,
   [0xa2] = -0.5625000000,
   [0xa3] = -0.5937500000,
   [0xa4] = -0.6250000000,
   [0xa5] = -0.6562500000,
   [0xa6] = -0.6875000000,
   [0xa7] = -0.7187500000,
   [0xa8] = -0.7500000000,
   [0xa9] = -0.7812500000,
   [0xaa] = -0.8125000000,
   [0xab] = -0.8437500000,
   [0xac] = -0.8750000000,
   [0xad] = -0.9062500000,
   [0xae] = -0.9375000000,
   [0xaf] = -0.9687500000,
   [0xb0] = -1.0000000000,
   [0xb1] = -1.0625000000,
   [0xb2] = -1.1250000000,
   [0xb3] = -1.1875000000,
   [0xb4] = -1.2500000000,
   [0xb5] = -1.3125000000,
   [0xb6] = -1.3750000000,
   [0xb7] = -1.4375000000,
   [0xb8] = -1.5000000000,
   [0xb9] = -1.5625000000,
   [0xba] = -1.6250000000,
   [0xbb] = -1.6875000000,
   [0xbc] = -1.7500000000,
   [0xbd] = -1.8125000000,
   [0xbe] = -1.8750000000,
   [0xbf] = -1.9375000000,
   [0xc0] = -2.0000000000,
   [0xc1] = -2.1250000000,
   [0xc2] = -2.2500000000,
   [0xc3] = -2.3750000000,
   [0xc4] = -2.5000000000,
   [0xc5] = -2.6250000000,
   [0xc6] = -2.7500000000,
   [0xc7] = -2.8750000000,
   [0xc8] = -3.0000000000,
   [0xc9] = -3.1250000000,
   [0xca] = -3.2500000000,
   [0xcb] = -3.3750000000,
   [0xcc] = -3.5000000000,
   [0xcd] = -3.6250000000,
   [0xce] = -3.7500000000,
   [0xcf] = -3.8750000000,
   [0xd0] = -4.0000000000,
   [0xd1] = -4.2500000000,
   [0xd2] = -4.5000000000,
   [0xd3] = -4.7500000000,
   [0xd4] = -5.0000000000,
   [0xd5] = -5.2500000000,
   [0xd6] = -5.5000000000,
   [0xd7] = -5.7500000000,
   [0xd8] = -6.0000000000,
   [0xd9] = -6.2500000000,
   [0xda] = -6.5000000000,
   [0xdb] = -6.7500000000,
   [0xdc] = -7.0000000000,
   [0xdd] = -7.2500000000,
   [0xde] = -7.5000000000,
   [0xdf] = -7.7500000000,
   [0xe0] = -8.0000000000,
   [0xe1] = -8.5000000000,
   [0xe2] = -9.0000000000,
   [0xe3] = -9.5000000000,
   [0xe4] = -10.0000000000,
   [0xe5] = -10.5000000000,
   [0xe6] = -11.0000000000,
   [0xe7] = -11.5000000000,
   [0xe8] = -12.0000000000,
   [0xe9] = -12.5000000000,
   [0xea] = -13.0000000000,
   [0xeb] = -13.5000000000,
   [0xec] = -14.0000000000,
   [0xed] = -14.5000000000,
   [0xee] = -15.0000000000,
   [0xef] = -15.5000000000,
   [0xf0] = -16.0000000000,
   [0xf1] = -17.0000000000,
   [0xf2] = -18.0000000000,
   [0xf3] = -19.0000000000,
   [0xf4] = -20.0000000000,
   [0xf5] = -21.0000000000,
   [0xf6] = -22.0000000000,
   [0xf7] = -23.0000000000,
   [0xf8] = -24.0000000000,
   [0xf9] = -25.0000000000,
   [0xfa] = -26.0000000000,
   [0xfb] = -27.0000000000,
   [0xfc] = -28.0000000000,
   [0xfd] = -29.0000000000,
   [0xfe] = -30.0000000000,
   [0xff] = -31.0000000000,
};

bool brw_find_packed_float(float *f, int count, uint32_t *out_packed)
{
   int i, j;
   uint32_t packed = 0, last_chan = 0;

   for (i = 0; i < count; i++) {
      for (j = 0; j < ARRAY_SIZE(packed_to_float); j++) {
	 if (f[i] == packed_to_float[j])
	    break;
      }

      if (j == ARRAY_SIZE(packed_to_float))
	 return false;

      packed |= j << (count * 8);
      last_chan = j;
   }

   /* Replicate the last channel out. */
   for (; count < 4; count++) {
      packed |= last_chan << (count * 8);
   }

   *out_packed = packed;
   return true;
}
